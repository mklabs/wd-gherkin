#!/usr/bin/env node

// Node runner
//
// TODO: Abstract away small difference between phantom / node runner,
// and make one

var fs   = require('fs');
var path = require('path');
var env  = process.env;

var Gherkin = require('gherkin').Lexer('en');

var nopt = global.nopt = require('nopt')({
  stepdir: String,
  config: String,
  tmpdir: String,
  timeout: Number
});

var tmpdir = nopt.tmpdir || './tmp';
var tmpfiles = [];

var files = nopt.argv.remain;
var config = {};

function isAbsolute(file) {
  return path.resolve(file) === file;
}

if (nopt.config) {
  config = require(isAbsolute(nopt.config) ? nopt.config : path.resolve(nopt.config));
} else if (env.JSON_CONFIG) {
  try {
    config = JSON.parse(env.JSON_CONFIG);
  } catch(e) {}
}

// Require & init mocha
var Mocha = require('mocha');
var mocha = new Mocha();

mocha.reporter('spec');

var timeout = nopt.timeout || config.timeout || 25000;
timeout = parseInt(timeout, 10);
mocha.timeout(isNaN(timeout) ? 25000 : timeout);

var Suite = Mocha.Suite;
var Test = Mocha.Test;
var utils = Mocha.utils;

// Parser
var Parser = require('../lib/parser');

var stepfiles = [];

// Steps matching

var steps = require('../lib/steps');

// Handle stepdir, loading every .js file under this dir
if (nopt.stepdir) {
  stepfiles = fs.readdirSync(nopt.stepdir).filter(function(file) {
    if (file === '.') return false;
    if (file === '..') return false;
    var filepath = path.join(nopt.stepdir, file);
    return fs.statSync(filepath).isFile();
  }).map(function(file) {
    return path.join(nopt.stepdir, file);
  });
}

// Handle test from config.json, writes temporary files
if (config.steps) {
  config.steps.forEach(function(step) {
    var filename = path.join(tmpdir, step.name);
    fs.writeFileSync(filename, (step.body || '') + '\n');
  });

  stepfiles = config.steps.map(function(step) {
    return path.join(tmpdir, step.name);
  });

  stepfiles.forEach(function(step) {
    tmpfiles.push(step);
  });
}

// Handle features from config.json, writes temporary files
if (config.features) {
  config.features.forEach(function(feature) {
    var filename = path.join(tmpdir, feature.name);
    fs.writeFileSync(filename, (feature.body || '') + '\n');
  });

  files = config.features.map(function(feature) {
    return path.join(tmpdir, feature.name);
  });

  files.forEach(function(step) {
    tmpfiles.push(step);
  });
}

stepfiles.forEach(function(file) {
  file = isAbsolute(file) ? file : path.resolve(file);
  require(file);
});

// Process, scan files, translate into mocha suites
files = files.map(function(file) {
  var filename = file;
  var body = fs.readFileSync(file, 'utf8');

  var parser = new Parser(mocha.suite, file, steps);
  var lexer = new Gherkin(parser);
  lexer.scan(body);

  return {
    filename: filename,
    body: body,
    parser: parser
  };
});

var runner = mocha.run(function(code) {
  process.exit(code);
});
