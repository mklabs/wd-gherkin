#!/usr/bin/env phantomjs

// Phantom runner
//
// TODO: Abstract away small difference between phantom / node runner,
// and make one

require('../vendor/phantomjs-nodify');

var fs   = require('fs');
var env  = require('system').env;
var path = require('path');

var Gherkin = require('gherkin').Lexer('en');

// Stubs for nopt
require.stub('url', function() {});
require.stub('stream', function() { return { Stream: function() {} }; });

var nopt = global.nopt = require('nopt')({
  stepdir: String,
  config: String,
  tmpdir: String,
  timeout: Number,
  webdriver: Number,
  'webdriver-host': String
});

var tmpdir = nopt.tmpdir || './tmp';
var tmpfiles = [];

var files = nopt.argv.remain;
var config = {};

if (nopt.config) {
  config = require(fs.isAbsolute(nopt.config) ? nopt.config : path.join(fs.workingDirectory, nopt.config));
} else if (env.JSON_CONFIG) {
  try {
    config = JSON.parse(env.JSON_CONFIG);
  } catch(e) {}
}

// Require & init mocha
var Mocha = require('mocha');
var mocha = new Mocha();

mocha.reporter('spec');

var timeout = nopt.timeout || config.timeout || 25000;
timeout = parseInt(timeout, 10);
mocha.timeout(isNaN(timeout) ? 25000 : timeout);

var Suite = Mocha.Suite;
var Test = Mocha.Test;
var utils = Mocha.utils;

// Parser
var Parser = require('../lib/parser');


var stepfiles = [];

// Steps matching

var steps = require('../lib/steps');

// Handle stepdir, loading every .js file under this dir
if (nopt.stepdir) {
  stepfiles = fs.list(nopt.stepdir).filter(function(file) {
    if (file === '.') return false;
    if (file === '..') return false;
    return fs.isFile(path.join(nopt.stepdir, file));
  }).map(function(file) {
    return path.join(nopt.stepdir, file);
  });
}

// Handle test from config.json, writes temporary files
if (config.steps) {
  config.steps.forEach(function(step) {
    var filename = path.join(tmpdir, step.name);
    fs.write(filename, (step.body || '') + '\n');
  });

  stepfiles = config.steps.map(function(step) {
    return path.join(tmpdir, step.name);
  });

  stepfiles.forEach(function(step) {
    tmpfiles.push(step);
  });
}

// Handle features from config.json, writes temporary files
if (config.features) {
  config.features.forEach(function(feature) {
    var filename = path.join(tmpdir, feature.name);
    fs.write(filename, (feature.body || '') + '\n');
  });

  files = config.features.map(function(feature) {
    return path.join(tmpdir, feature.name);
  });

  files.forEach(function(step) {
    tmpfiles.push(step);
  });
}

stepfiles.forEach(function(file) {
  file = fs.isAbsolute(file) ? file : path.join(fs.workingDirectory, file);
  require(file);
});

// Process, scan files, translate into mocha suites
files = files.map(function(file) {
  var filename = file;
  var body = fs.read(file);

  var parser = new Parser(mocha.suite, file, steps);
  var lexer = new Gherkin(parser);
  lexer.scan(body);

  return {
    filename: filename,
    body: body,
    parser: parser
  };
});

var runner = mocha.run(function(code) {
  process.exit(code);
});
